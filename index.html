<!DOCTYPE html>
<html lang="en" ng-app="fscApp" >
	<head>

        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0"; />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
        <meta charset='utf-8' />
        
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <link rel="apple-touch-icon" href="apple-touch-icon-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png" />
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="pragma" content="no-cache" />
		<!--link rel="stylesheet" href="css/main.css"-->


		<style>

		  body {
		  	background-color : lightgray;
		  	padding : 0px;
		  	margin : 0px;
		  }
		  h1 {
		  	color : blue;
		  }
		  p {
		  	color : green;
		  }

		</style>

		<script type="text/javascript">

			var BG_IMG = new Image();
			var BG_IMG_DATA_ARRAY = [];

			var drawImagePixel = function(canvasDataArray, canvasRedAt, imageDataArray, imageReadAt) {

				canvasDataArray[canvasRedAt + 0] = imageDataArray[imageReadAt + 0];
				canvasDataArray[canvasRedAt + 1] = imageDataArray[imageReadAt + 1];
				canvasDataArray[canvasRedAt + 2] = imageDataArray[imageReadAt + 2];
				canvasDataArray[canvasRedAt + 3] = imageDataArray[imageReadAt + 3];

			};

			var drawTransparent = function(canvasDataArray, redAt) {
				canvasDataArray[redAt    ] = 255;
				canvasDataArray[redAt + 3] = 150;

			};

			var render = function (ctx, imageData, imageDataData, w, h) {

				// loop each pixel render a whole picture
				var drawX = 0;
				var drawY = 0;

				var colorArray = [0, 0, 0, 255];
				var redAt = 0;

				for (drawY = 0; drawY < h; drawY++) {
					for (drawX = 0; drawX < w; drawX++) {

						if (drawX > (320 / 2) || drawY > (240 / 2)) {
							drawTransparent(imageDataData, redAt);
						} else {
							drawImagePixel(imageDataData, redAt, BG_IMG_DATA_ARRAY, ((320 * drawY) + drawX) * 4);
						}



						redAt += 4;
					}
				}

				ctx.putImageData(imageData, 0, 0);
			};

			var getRawImageData = function(img) {

				var cav = document.createElement('canvas');
				var ctx = cav.getContext('2d');
				ctx.drawImage(img, 0, 0);

				return ctx.getImageData(0, 0, img.width, img.height);
			};

			var init = function () {

				// screen size
				var width = 320;
				var height = 480;
				var scale = 0.5;

				// game canvas and context
				var cav = document.getElementById('game_canvas');
				var ctx = cav.getContext('2d');

				cav.width = width;
				cav.height = height;

				ctx.mozImageSmoothingEnabled = false;
				ctx.msImageSmoothingEnabled = false;
				ctx.imageSmoothingEnabled = false;
				ctx.fillStyle = '#00F';
				ctx.fillRect(0, 0, 320, 480);

				// fps counter
				var date = new Date();
				var cft = date.getTime();
				var pft = cft;
				var tl = 0;
				ctx.fillStyle = '#FFF';
				ctx.textAlign = 'left';
				ctx.font='20px Arial';

				var bgCav = document.createElement('canvas');
				var bgCtx = bgCav.getContext('2d');

				bgCav.width = width * scale;
				bgCav.height = height * scale;

				// reusable image data (for faster render)
				var imageData = bgCtx.createImageData(width * scale, height * scale);
				var imageDataData = imageData.data;

				var start = function(){

					// game loop
					var loop = setInterval(function(){

						// render image
						ctx.clearRect(0, 0, width, height);

						render(bgCtx, imageData, imageDataData, width * scale, height * scale);
		    			ctx.drawImage(bgCav, 0, 0, width, height);

						// render fps
						date = new Date();
						pft = cft;
						cft = date.getTime();
						tl = Math.min(cft - pft, 100);
						date = null;
		    			ctx.fillText('SCALE: ' + scale + ', FPS: ' + ~~(1000/tl), 0, 20);


					}, 1000/60);

				};

				// load image
				BG_IMG = new Image();
				BG_IMG.onload = function(e){
					BG_IMG_DATA_ARRAY = getRawImageData(BG_IMG).data;
					start();
				}
				BG_IMG.src = 'ground.png';
			};


		</script>

	</head>
	<body onload="init()">
		
		<canvas id="game_canvas"></canvas>

	</body>
</html>